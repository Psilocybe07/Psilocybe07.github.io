<!DOCTYPE html>
<html>
<head>
    </head>
<body>
    <script>
        // ... (Constants and most variables remain the same)

        let playerListContent;

        // Debugging variables
        let debugLog = document.createElement('div');
        debugLog.style.cssText = "position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:5px;font-family:Arial,sans-serif;z-index:1000;max-height:200px;overflow-y:scroll;";
        document.body.appendChild(debugLog);

        function logDebug(message) {
            debugLog.innerHTML += message + "<br>";
            debugLog.scrollTop = debugLog.scrollHeight; // Auto-scroll
        }


        // ... (Player class remains the same)

        function initGame() { // ... (Phaser config remains the same) }
        function preload() { // ... (Preload function remains the same) }

        function create() {
            // ... (Bullet pool initialization remains the same)

            playerListContent = document.getElementById('playerListContent');

            // Initialize PeerJS with logging
            peer = new Peer({
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                },
                debug: 3 // Set debug level (0-3, 3 is most verbose)
            });

            peer.on('open', (id) => {
                logDebug("Peer opened with ID: " + id);
                initializePlayer(id);
            });

            peer.on('connection', handleConnection);
            peer.on('disconnected', handlePeerDisconnect);
            peer.on('error', (err) => {
                logDebug("PeerJS Error: " + err.message);
            });

            // ... (Rest of create function remains the same)
        }

        function initializePlayer(id) {
            // ... (Player initialization remains the same)
            logDebug("Local player initialized.");
        }

        function update(time, delta) { // ... (Update function mostly remains the same) }

        // Network Functions
        function handleConnection(conn) {
            logDebug("Connection received from: " + conn.peer);
            connections[conn.peer] = conn;

            conn.on('open', () => {
                logDebug("Connection opened to: " + conn.peer);
                sendPlayerState(conn);
                startPingInterval(conn);
            });

            conn.on('data', (data) => {
                logDebug("Received data from " + conn.peer + ": " + JSON.stringify(data));
                handleNetworkData(data);
            });

            conn.on('close', () => {
                logDebug("Connection closed to: " + conn.peer);
                handlePlayerDisconnect(conn.peer);
            });
            conn.on('error', (err) => {
                logDebug("Connection error to " + conn.peer + ": " + err.message);
                handlePlayerDisconnect(conn.peer);
            });
        }

        function handlePeerDisconnect() {
            logDebug("Peer disconnected. Cleaning up.");
            window.location.reload();
        }

        function handlePlayerDisconnect(peerId) {
            // ... (Handle disconnect logic remains the same)
            logDebug("Player disconnected: " + peerId);
        }

        function handleNetworkData(data) {
            // ... (Handle network data logic remains the same)
        }

        // ... (Other functions remain the same)

        function startGame() {
            playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter a name!');
                return;
            }

            logDebug("Starting game with player name: " + playerName); // Log the player name
            document.getElementById('loginScreen').style.display = 'none';
            initGame();
        }

    </script>
</body>
</html>
